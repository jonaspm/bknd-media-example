---
import { getApi } from "../bknd";
import Layout from "../layouts/Layout.astro";

const api = await getApi(Astro, { verify: true });
const basicUser = api.getUser();

// Redirect to login if not authenticated
if (!basicUser) {
   return Astro.redirect("/admin/auth/login");
}

// Fetch user with photo relation using readOne
const { data: user } = await api.data.readOne("users", basicUser.id, {
   with: ['photo']
}) as { data: Record<string, any> | null };

// Get the user's photo URL if they have one
const photoUrl = user?.photo ? `/api/media/file/${user.photo.path}` : null;

export const prerender = false;
---

<Layout title="Profile - Photo Upload">
   <p slot="context">User Profile</p>

   <div class="profile-container">
      <div class="photo-section">
         <div class="photo-preview">
            {photoUrl ? (
               <img src={photoUrl} alt="User photo" class="photo-image" id="photo-preview" />
            ) : (
               <div class="photo-placeholder" id="photo-placeholder">
                  <span>No Photo</span>
               </div>
            )}
         </div>

         <div class="user-info">
            <p><strong>Email:</strong> {user.email}</p>
            {user.username && <p><strong>Username:</strong> {user.username}</p>}
         </div>
      </div>

      <div class="upload-section">
         <h3>Upload Profile Photo</h3>
         <form id="upload-form" enctype="multipart/form-data">
            <input
               type="file"
               id="file-input"
               name="file"
               accept="image/*"
               class="file-input"
            />
            <label for="file-input" class="file-label">
               Choose File
            </label>
            <span id="file-name" class="file-name">No file chosen</span>
            <button type="submit" class="upload-button" id="upload-btn" disabled>
               Upload Photo
            </button>
         </form>
         <div id="upload-status" class="upload-status"></div>
      </div>

      <div class="actions">
         <a href="/ssr">‚Üê Back to Home</a>
         <a href="/api/auth/logout">Logout</a>
      </div>
   </div>
</Layout>

<script>
   import { api } from "../utils/bkndClient";

   const fileInput = document.getElementById('file-input') as HTMLInputElement;
   const fileName = document.getElementById('file-name') as HTMLSpanElement;
   const uploadBtn = document.getElementById('upload-btn') as HTMLButtonElement;
   const uploadForm = document.getElementById('upload-form') as HTMLFormElement;
   const uploadStatus = document.getElementById('upload-status') as HTMLDivElement;
   const photoPreview = document.getElementById('photo-preview') as HTMLImageElement | null;
   const photoPlaceholder = document.getElementById('photo-placeholder') as HTMLDivElement | null;

   fileInput.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const file = target.files?.[0];
      if (file) {
         fileName.textContent = file.name;
         uploadBtn.disabled = false;
      } else {
         fileName.textContent = 'No file chosen';
         uploadBtn.disabled = true;
      }
   });

   uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = fileInput.files?.[0];
      if (!file) {
         uploadStatus.textContent = 'Please select a file first';
         uploadStatus.className = 'upload-status error';
         return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      uploadStatus.textContent = '';

      try {
        // Get current user to get their ID
        const { data: meData } = await api.auth.me();
        if (!meData?.user?.id) {
           throw new Error('User not authenticated');
        }

        // Upload to the user's photo field using bknd client API
        const response = await api.media.uploadToEntity(
           "users",
           meData.user.id,
            "photo",
            file
         );

         // Check if response contains an error
         const responseData = response?.data as any;
         if (responseData?.error) {
            throw new Error(responseData.error);
         }

         uploadStatus.textContent = 'Photo uploaded successfully!';
         uploadStatus.className = 'upload-status success';

         // Update the preview
         const newImageUrl = URL.createObjectURL(file);
         if (photoPreview) {
            photoPreview.src = newImageUrl;
         } else if (photoPlaceholder) {
            const img = document.createElement('img');
            img.src = newImageUrl;
            img.alt = 'User photo';
            img.className = 'photo-image';
            img.id = 'photo-preview';
            photoPlaceholder.replaceWith(img);
         }

         // Reset form
         fileInput.value = '';
         fileName.textContent = 'No file chosen';
      } catch (error: any) {
         uploadStatus.textContent = `Upload error: ${error.message}`;
         uploadStatus.className = 'upload-status error';
      } finally {
         uploadBtn.disabled = false;
         uploadBtn.textContent = 'Upload Photo';
      }
   });
</script>

<style>
   .profile-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 2rem;
   }

   .photo-section {
      text-align: center;
      margin-bottom: 2rem;
   }

   .photo-preview {
      width: 150px;
      height: 150px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid rgb(var(--accent));
   }

   .photo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
   }

   .photo-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--accent), 0.2);
      color: rgb(var(--accent-light));
      font-size: 0.9rem;
   }

   .user-info {
      font-size: 1rem;
   }

   .user-info p {
      margin: 0.5rem 0;
      opacity: 0.9;
   }

   .upload-section {
      background: rgba(var(--accent), 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
   }

   .upload-section h3 {
      margin: 0 0 1rem;
      font-size: 1.2rem;
      color: rgb(var(--accent-light));
   }

   #upload-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
   }

   .file-input {
      display: none;
   }

   .file-label {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: rgb(var(--accent));
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: bold;
   }

   .file-label:hover {
      background: rgb(var(--accent-dark));
   }

   .file-name {
      font-size: 0.9rem;
      opacity: 0.7;
   }

   .upload-button {
      padding: 0.75rem 2rem;
      background: linear-gradient(45deg, rgb(var(--accent)), rgb(var(--accent-light)));
      color: rgb(var(--accent-dark));
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: opacity 0.2s, transform 0.2s;
   }

   .upload-button:hover:not(:disabled) {
      transform: translateY(-2px);
   }

   .upload-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
   }

   .upload-status {
      text-align: center;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
   }

   .upload-status.success {
      color: #4ade80;
   }

   .upload-status.error {
      color: #f87171;
   }

   .actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
   }

   .actions a {
      color: rgb(var(--accent-light));
      text-decoration: none;
      font-size: 0.9rem;
   }

   .actions a:hover {
      text-decoration: underline;
   }
</style>
